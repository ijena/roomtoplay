<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoomToPlay: Impostor Game</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    .screen { display: none; }
    .active { display: block; }
    input, button { padding: 10px; margin: 5px; font-size: 16px; }
    #promptBox { margin-top: 2em; font-size: 1.2em; font-weight: bold; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>üïµÔ∏è RoomToPlay: Find the Impostor</h1>

  <!-- Home Screen -->
  <div id="homeScreen" class="screen active">
    <button onclick="showScreen('createScreen')">Create Room</button>
    <button onclick="showScreen('joinScreen')">Join Room</button>
  </div>

  <!-- Create Room Screen -->
  <div id="createScreen" class="screen">
    <h2>Create Room</h2>
    <input type="text" id="createName" placeholder="Your name" />
    <button onclick="createRoom()">Create</button>
  </div>

  <!-- Join Room Screen -->
  <div id="joinScreen" class="screen">
    <h2>Join Room</h2>
    <input type="text" id="joinName" placeholder="Your name" />
    <input type="text" id="joinCode" placeholder="Room code" />
    <button onclick="joinRoom()">Join</button>
  </div>

  <!-- Lobby/Game Screen -->
  <div id="lobbyScreen" class="screen">
    <h2>Game Lobby</h2>
    <p id="roomInfo"></p>
    <div id="playerList"></div>
    <div id="currentSettings"></div>
    <div id="hostControls" style="display: none;">
  <label for="impostorModeSelect"><strong>Impostor Mode:</strong></label>
  <select id="impostorModeSelect" onchange="updateImpostorSetting()">
    <option value="variable">Variable Impostors</option>
    <option value="one">One Impostor</option>
  </select>
  <br>
  <button onclick="startRound()">Start Round</button>
  <button onclick="skipPrompt()">Skip Question</button>

</div>

    <div id="promptBox"></div>
  <div id="answerSection" style="margin-top: 20px; display: none;">
  <input type="text" id="answerInput" placeholder="Type your answer..." />
  <button onclick="submitAnswer()">Submit Answer</button>
</div>

<div id="answersReveal" style="margin-top: 30px;"></div>

<div id="voteSection" style="display: none;">
  <h3>Vote: Who do you think is the impostor?</h3>
  <form id="voteForm"></form>
  <button onclick="submitVote()">Submit Vote</button>
</div>

</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io("/impostor");
    let playerName = "";
    let roomCode = "";
    let allPlayers = []; // üÜï to store players for voting
    let impostorMode = "variable"; // Default mode

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(div => div.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function createRoom() {
      playerName = document.getElementById("createName").value.trim();
      if (!playerName) return alert("Enter your name.");
      socket.emit("create-room", { playerName });
    }

    function joinRoom() {
      playerName = document.getElementById("joinName").value.trim();
      roomCode = document.getElementById("joinCode").value.trim().toUpperCase();
      if (!playerName || !roomCode) return alert("Fill in both fields.");
      socket.emit("join", { playerName, roomCode });
    }
    function updatePlayerList(players) {
        allPlayers = players; // Store for voting later
  const list = players.map(p => `‚Ä¢ ${p.name}`).join("<br>");
  document.getElementById("playerList").innerHTML = `<strong>Players:</strong><br>${list}`;
}


    function startRound() {
      socket.emit("start-round");
    }
    function updateImpostorSetting() {
  const selected = document.getElementById("impostorModeSelect").value;
  socket.emit("update-settings", { impostorMode: selected });
}

function updateCurrentSettings(settings) {
  impostorMode = settings.impostorMode; // ‚úÖ Keeps local copy in sync

  const modeText = settings.impostorMode === "one" ? "One Impostor" : "Variable Impostors";
  document.getElementById("currentSettings").innerHTML = `<em>Impostor Mode: ${modeText}</em>`;
  document.getElementById("impostorModeSelect").value = settings.impostorMode;
}
function skipPrompt() {
  socket.emit("start-round");
}
function submitAnswer() {
  const answer = document.getElementById("answerInput").value.trim();
  if (!answer) return alert("Enter an answer first.");
  socket.emit("submit-answer", { answer });
  document.getElementById("answerInput").disabled = true;
}
function renderVotingForm() {
  const form = document.getElementById("voteForm");
  form.innerHTML = ""; // Reset votes every round

  allPlayers.forEach((p) => {
    if (p.name !== playerName) {
      const input = document.createElement("input");
      input.type = impostorMode === "one" ? "radio" : "checkbox";
      input.name = "vote";
      input.value = p.name;
      input.id = `vote-${p.name}`;

      const label = document.createElement("label");
      label.htmlFor = input.id;
      label.textContent = p.name;

      form.appendChild(input);
      form.appendChild(label);
    }
  });

  document.getElementById("voteSection").style.display = "block";
}
function submitVote() {
  const form = document.getElementById("voteForm");
  const votes = Array.from(form.querySelectorAll("input:checked")).map((input) => input.value);
  if (votes.length === 0 && impostorMode=="one") return alert("Please select at least one player.");
  socket.emit("submit-vote", { votes });
  document.getElementById("voteSection").style.display = "none";
}





    // Reconnect support
    socket.on("connect", () => {
      if (playerName && roomCode) {
        socket.emit("rejoin-room", { playerName, roomCode });
      }
    });

    socket.on("room-created", ({ roomCode: code,players }) => {
      roomCode = code;
      document.getElementById("roomInfo").innerText = `Room: ${roomCode} | You: ${playerName}`;
    updatePlayerList(players);

      showScreen("lobbyScreen");
    });

    socket.on("joined-room", ({ roomCode: code,players }) => {
      roomCode = code;
      document.getElementById("roomInfo").innerText = `Room: ${roomCode} | You: ${playerName}`;
      updatePlayerList(players);

      showScreen("lobbyScreen");
    });

    socket.on("host-assigned", ({ message }) => {
      document.getElementById("hostControls").style.display = "block";
      console.log(message);
    });

    socket.on("prompt", ({ prompt }) => {
  document.getElementById("promptBox").innerText = `Your prompt:\n${prompt}`;
  document.getElementById("answerSection").style.display = "block";
  document.getElementById("answerInput").value = "";
  document.getElementById("answerInput").disabled = false;
  document.getElementById("answersReveal").innerHTML = "";
});

   socket.on("update-players", (players) => {
  allPlayers = players; // ‚úÖ Make sure everyone‚Äôs copy of allPlayers stays synced
  const list = players.map(p => `‚Ä¢ ${p.name}`).join("<br>");
  document.getElementById("playerList").innerHTML = `<strong>Players:</strong><br>${list}`;
});

    socket.on("settings-updated", (settings) => {
  updateCurrentSettings(settings);
  impostorMode = settings.impostorMode; // Store for voting logic
});

socket.on("reveal-answers", (allAnswers) => {
  let html = "<h3>Everyone's Answers:</h3><ul>";
  for (const { name, answer } of allAnswers) {
    html += `<li><strong>${name}:</strong> ${answer}</li>`;
  }
  html += "</ul>";
  document.getElementById("answersReveal").innerHTML = html;
  renderVotingForm(); // Start voting right after answer reveal

});

socket.on("vote-results", ({ tally, byPlayer }) => {
  console.log("‚úÖ vote-results:", { tally, byPlayer });
  let html = "<h3>Vote Results:</h3><ul>";

  tally.forEach(([name, count]) => {
    const votesText = count === 1 ? "vote" : "votes";
    // ‚úÖ Convert "__NONE__" into readable label
    const displayName = (name === "__NONE__" || name === "None") ? "No one" : name;
    html += `<li><strong>${displayName}</strong>: ${count} ${votesText}</li>`;
  });
  html += "</ul>";

  html += "<h4>Who Voted for Whom:</h4><ul>";
  for (const [voterId, votedNames] of Object.entries(byPlayer)) {
    const voter = allPlayers.find(p => p.id === voterId);
    const voterName = voter ? voter.name : "Unknown Player";
    const votedDisplay = votedNames
      .map(n => (n === "__NONE__" ? "No one" : n))
      .join(", ");
    html += `<li><strong>${voterName}</strong> ‚Üí ${votedDisplay}</li>`;
  }
  html += "</ul>";

if (impostors && impostors.length > 0) {
  const displayNames = impostors.map(name => (name === "__NONE__" ? "No one" : name)).join(", ");
  document.getElementById("answersReveal").innerHTML += `
    <h3>üö® Impostor${impostors.length > 1 ? "s" : ""} Revealed:</h3>
    <p><strong>${displayNames}</strong></p>
  `;
} else {
  document.getElementById("answersReveal").innerHTML += `
    <h3>üò∂ No impostor identified this round!</h3>
  `;
}
  document.getElementById("voteSection").style.display = "none";
});




    socket.on("error", (msg) => alert("‚ùå " + msg));
    
  </script>
</body>
</html>
